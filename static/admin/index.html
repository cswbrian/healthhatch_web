<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <!-- Explicitly link to config to ensure discovery -->
  <link href="/admin/config.yml" type="text/yaml" rel="cms-config-url">
</head>
<body>
  <!-- Load Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <!-- Auth Token Handling -->
  <script>
    // Listen for auth messages from the popup (Worker -> Popup -> Here)
    window.addEventListener('message', function(event) {
      if (typeof event.data === 'string' && event.data.startsWith('authorization:')) {
        console.log('[AUTH] Authorization message received:', event.data);
        
        // Parse the message to extract token
        try {
           const parts = event.data.split(':');
           if (parts.length >= 4) {
             const dataStr = parts.slice(3).join(':');
             const data = JSON.parse(dataStr);
             
             if (data.token) {
               console.log('[AUTH] Token found, saving to localStorage...');
               // Save token where Decap CMS expects it
               // Note: 'github' must match the backend name in config.yml
               const user = { 
                 token: data.token, 
                 backendName: 'github'
               };
               localStorage.setItem('netlify-cms-user', JSON.stringify(user));
               
               // Reload to force Decap CMS to pick up the session
               // console.log('[AUTH] Reloading page...');
               // window.location.reload();
             }
           }
        } catch(e) {
          console.error('[AUTH] Error processing token:', e);
        }
      }
    });
  </script>
</body>
</html>
