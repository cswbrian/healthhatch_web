<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
</head>
<body>
  <script>
    console.log('=== Decap CMS Debug Logging ===');
    
    // Log all messages received
    window.addEventListener('message', function(event) {
      console.log('[MESSAGE] Received:', event.data);
      console.log('[MESSAGE] From origin:', event.origin);
      console.log('[MESSAGE] Current origin:', window.location.origin);
      
      // Check if it's an authorization message
      if (typeof event.data === 'string' && event.data.startsWith('authorization:')) {
        console.log('[AUTH] Authorization message detected!');
        console.log('[AUTH] Full message:', event.data);
        
        // Parse the message
        const parts = event.data.split(':');
        if (parts.length >= 4) {
          const provider = parts[1];
          const status = parts[2];
          const dataStr = parts.slice(3).join(':');
          console.log('[AUTH] Provider:', provider);
          console.log('[AUTH] Status:', status);
          console.log('[AUTH] Data:', dataStr);
          
          try {
            const data = JSON.parse(dataStr);
            console.log('[AUTH] Parsed data:', data);
            console.log('[AUTH] Token present:', !!data.token);
          } catch (e) {
            console.error('[AUTH] Failed to parse data:', e);
          }
        }
      }
    });
    
    // Wait for Decap CMS to fully initialize
    window.addEventListener('load', function() {
      console.log('[CMS] Window loaded, waiting for Decap CMS...');
      
      let checkCount = 0;
      const checkInterval = setInterval(function() {
        checkCount++;
        console.log(`[CMS] Check #${checkCount}: Looking for Decap CMS...`);
        
        if (window.CMS) {
          console.log('[CMS] ✅ Decap CMS found!');
          console.log('[CMS] CMS object keys:', Object.keys(window.CMS));
          
          // Try multiple ways to access the backend
          let backend = null;
          
          // Method 1: getBackend()
          if (window.CMS.getBackend) {
            try {
              backend = window.CMS.getBackend();
              console.log('[CMS] getBackend() result:', backend);
            } catch (e) {
              console.log('[CMS] getBackend() error:', e);
            }
          } else {
            console.log('[CMS] getBackend() method not found');
          }
          
          // Method 2: Check for init() and see if we need to initialize
          if (window.CMS.init) {
            console.log('[CMS] init() method found');
            try {
              // Check if CMS is already initialized by looking for the root element
              const cmsRoot = document.getElementById('nc-root') || document.querySelector('[data-netlify-cms]');
              if (!cmsRoot) {
                console.log('[CMS] CMS root not found, may need initialization');
              } else {
                console.log('[CMS] CMS root found:', cmsRoot);
              }
            } catch (e) {
              console.log('[CMS] Error checking root:', e);
            }
          }
          
          // Method 3: Look for backend in window object
          if (window.netlifyIdentity) {
            console.log('[CMS] netlifyIdentity found:', window.netlifyIdentity);
          }
          
          // Method 4: Check if there's a CMS instance stored somewhere
          if (window.CMS.registerBackend) {
            console.log('[CMS] registerBackend method found');
          }
          
          // Check if backend is actually initialized
          if (backend) {
            console.log('[CMS] ✅ Backend found!');
            console.log('[CMS] Backend name:', backend.name);
            console.log('[CMS] Backend methods:', Object.keys(backend));
            
            // Check authentication state
            if (typeof backend.currentUser === 'function') {
              try {
                const user = backend.currentUser();
                console.log('[CMS] Current user:', user);
              } catch (e) {
                console.log('[CMS] Error getting current user:', e);
              }
            }
          } else {
            console.warn('[CMS] ⚠️ Backend is still undefined');
            console.log('[CMS] This might mean CMS hasn\'t fully initialized yet');
            
            // If we've checked many times and still no backend, try to manually trigger
            if (checkCount > 10) {
              console.log('[CMS] Attempting to find CMS instance in DOM...');
              const cmsRoot = document.getElementById('nc-root') || document.querySelector('[data-netlify-cms]');
              if (cmsRoot) {
                console.log('[CMS] Found CMS root element, CMS should be initialized');
              }
            }
          }
          
          // Only clear interval if we found backend OR checked many times
          if (backend || checkCount > 30) {
            clearInterval(checkInterval);
            if (!backend) {
              console.error('[CMS] ❌ Backend never initialized after 30 checks');
            }
          }
        } else if (checkCount > 20) {
          console.warn('[CMS] ⚠️ Decap CMS not found after 20 checks');
          clearInterval(checkInterval);
        }
      }, 500);
    });
    
    // Log any errors
    window.addEventListener('error', function(event) {
      console.error('[ERROR]', event.error || event.message, event);
    });
    
    // Log unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      console.error('[PROMISE REJECTION]', event.reason);
    });
  </script>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // After Decap CMS script loads, check if it initialized properly
    setTimeout(function() {
      console.log('[CMS] Checking config accessibility...');
      
      // Try to fetch the config to see if it's accessible
      fetch('/admin/config.yml')
        .then(response => {
          console.log('[CMS] Config fetch status:', response.status);
          if (response.ok) {
            return response.text();
          } else {
            console.error('[CMS] Config not accessible, status:', response.status);
          }
        })
        .then(configText => {
          if (configText) {
            console.log('[CMS] Config file is accessible, length:', configText.length);
            console.log('[CMS] Config preview:', configText.substring(0, 200));
          }
        })
        .catch(error => {
          console.error('[CMS] Error fetching config:', error);
        });
      
      // Check if CMS initialized and try to get backend again
      if (window.CMS) {
        console.log('[CMS] Re-checking backend after delay...');
        setTimeout(function() {
          if (window.CMS.getBackend) {
            const backend = window.CMS.getBackend();
            console.log('[CMS] Backend after delay:', backend);
            if (backend) {
              console.log('[CMS] ✅ Backend initialized!');
            } else {
              console.warn('[CMS] ⚠️ Backend still undefined - CMS may not have loaded config');
            }
          }
        }, 2000);
      }
    }, 3000);
  </script>
</body>
</html>
